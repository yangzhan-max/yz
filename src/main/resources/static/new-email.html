<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>重置邮箱</title>
    <!-- Standard -->
    <link rel="shortcut icon" href="/logo/logo_title.png">
    <!-- Styles -->
    <link href="assets/fontAwesome/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="assets/css/lib/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/lib/nixon.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="./layui/css/layui.css" rel="stylesheet">
</head>

<body class="bg-primary">
<div class="Nixon-login">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-lg-offset-3">
                <div class="login-content">
                    <div class="login-logo">
                        <a><span>By Chen</span></a>
                    </div>
                    <div class="login-form">
                        <h4>重置邮箱</h4>
                        <form id="form-reset">
                            <div id="empty"></div>
                            <div class="form-group ">
                                <label>新邮箱地址</label>
                                <input id="email" type="email" class="form-control input-default" placeholder="输入邮箱地址">
                            </div>
                            <div class="form-group">
                                <label>验证码</label>
                                <div class="input-group input-group-flat">
                                    <input id="input-code" type="text" class="form-control input-default"
                                           placeholder="输入获取到的验证码" oninput="value=value.replace(/[^\d]/g,'')"/>
                                    <span id="check" class="input-group-btn">
                                            <button id="btn-code" class="layui-btn layui-btn-primary" type="button">获取验证码</button>
                                        </span>
                                </div>
                            </div>

                            <button id="btn-reset" type="button" class="btn btn-primary btn-flat m-b-15">重置邮箱</button>
                            <div class="register-link text-center">
                                <p>返回 <a href="index.html">主页</a></p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="./layui/layui.js"></script>
<script>
    layui.use(['layer', 'jquery'], function () {
        let layer = layui.layer, $ = layui.$;

        let InterValObj; //timer变量，控制时间
        let count = 60; //间隔函数，1秒执行
        let curCount;//当前剩余秒数
        //获取验证码
        $('#btn-code').click(function () {
            let email = $('#email').val();
            //邮箱不能为空
            if (email.length === 0) {
                layer.msg('请输入邮箱');
                return;
            }

            curCount = count;
            //设置button效果，开始计时
            $("#btn-code").addClass('layui-btn-disabled')
                .attr("disabled", "disabled")
                .html(curCount + "秒后重新获取");
            //启动计时器，1秒执行一次
            InterValObj = window.setInterval(SetRemainTime, 1000);

            //发送邮箱到后台
            $.ajax({
                url: "/reset/vl-newEmail",
                type: "get",
                data: {
                    newEmail: email
                },

                success: function (data) {
                    if (data.code === "001") {
                        //邮箱验证码发送成功
                        layer.msg("邮件发送成功");
                        return;
                    }
                    if (data.code === "000") {
                        //发送失败
                        layer.msg("<em style='color: black'>邮件发送失败!请重新试一次</em>", {icon: 5});
                        return;
                    }
                    alert("服务器返回未知错误！");
                },
                error: function (xhr) {
                    alert("验证码请求错误！错误原因为： " + xhr.status + " " + xhr.statusText);
                },
                complete: function () {
                    //验证码框失去焦点
                    $('#input-code').blur(function () {

                        let checkCode = $('#input-code').val();
                        if (checkCode.length === 0 || checkCode.length < 6) {
                            return;
                        }
                        //将验证码发到后台
                        $.ajax({
                            url: "/reset/vl-code",
                            type: "get",
                            data: {
                                checkCode: checkCode
                            },
                            success: function (res) {
                                if (res.code === '201') {
                                    $('#empty').attr('class', 'alert alert-info').html("验证码输入正确！");
                                }
                                if (res.code === '202') {
                                    $('#empty').attr('class', 'alert alert-danger').html("验证码错误！");
                                }
                            },
                            error: function (xhr) {
                                alert("验证码请求错误！错误原因为： " + xhr.status + " " + xhr.statusText);
                            }
                        });

                    });
                }
            });
        });

        //比对验证码，重新设置密码
        $('#btn-reset').click(function () {
            let email = $('#email').val();
            let checkCode = $('#input-code').val();

            if (email.length === 0) {
                layer.msg('请输入邮箱');
                return;
            }
            if (checkCode.length === 0) {
                layer.msg('请输入验证码');
                return;
            }
            //发送验证码和密码到后台
            $.ajax({
                url: "/reset/up-email",
                type: "get",
                data: {
                    checkCode: checkCode,
                    newEmail: email,
                }, beforeSend: function () {
                    $("#btn-reset").attr({disabled: "disabled"});
                },
                success: function (data) {
                    //验证码比对成功
                    if (data.code === "201") {
                        if (data.data === "邮箱更改成功") {
                            //更新邮箱成功
                            layer.msg("邮箱修改成功！", {time: 1000});
                            setTimeout(function () {
                                window.location.href = "index.html";
                            }, 3000);
                            return;
                        } else if (data.data === "邮箱更改异常") {
                            //更新邮箱失败
                            layer.msg("邮箱修改失败！请重新试一次", {time: 1000});
                            setTimeout(function () {
                                window.location.href = "index.html";
                            }, 3000);
                            return;
                        }
                    }
                    if (data.code === "202") {
                        //验证码比对错误
                        layer.msg("<em style='color:black'>" + "验证码错误！</em>", {icon: 5});
                        return;
                    }
                    if (data.code === "000") {
                        alert("请求失败！请重新试一次");
                        return;
                    }
                    alert("服务器返回未知错误！");
                },
                error: function (xhr) {
                    alert("验证码请求错误！错误原因为： " + xhr.status + " " + xhr.statusText);
                }
            });

        });

        //timer处理函数
        function SetRemainTime() {
            if (curCount === 0) {
                window.clearInterval(InterValObj);//停止计时器
                $("#btn-code").attr('class', 'layui-btn layui-btn-primary')
                    .removeAttr("disabled")
                    .html("重新发送验证码")
            } else {
                curCount--;
                $("#btn-code").html(curCount + "秒后重新获取");
            }
        };
    });


</script>
</html>